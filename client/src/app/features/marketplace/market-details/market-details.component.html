<div class="container mx-auto px-4 py-8">
  @if (market$ | async; as vm) {
    @switch (vm.status) {
      @case ('loading') {
        <div class="flex justify-center items-center p-8">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      }
      @case ('error') {
        <div class="text-center p-8">
          <mat-icon class="text-6xl text-red-500 mb-4">error_outline</mat-icon>
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Erreur de Chargement</h2>
          <p class="text-gray-600 mb-8">{{vm.error}}</p>
          <button 
            type="button"
            mat-raised-button 
            color="primary" 
            (click)="loadMarketDetails(vm.data?.id!)"
            class="bg-blue-600 hover:bg-blue-700"
          >
            <mat-icon class="mr-2">refresh</mat-icon>
            Réessayer
          </button>
        </div>
      }
      @case ('success') {
        <!-- Back Navigation -->
        <button 
          type="button"
          mat-button 
          routerLink="/marketplace" 
          class="inline-flex items-center text-blue-600 hover:text-blue-700 mb-6 transition-colors"
        >
          <mat-icon class="mr-1">arrow_back</mat-icon>
          Retour au Marketplace
        </button>

        <!-- Modern Market Header -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8 market-header">
          <div class="relative h-80 lg:h-96">
            <img 
              [src]="vm.data?.coverImage" 
              [alt]="vm.data?.name"
              class="w-full h-full object-cover"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
            
            <!-- Market Info Overlay -->
            <div class="absolute bottom-0 left-0 right-0 p-6 lg:p-8">
              <div class="flex flex-col sm:flex-row items-start sm:items-center">
                <div class="relative mb-4 sm:mb-0 sm:mr-6">
                  <img 
                    [src]="vm.data?.logo" 
                    [alt]="vm.data?.name + ' logo'"
                    class="w-24 h-24 lg:w-32 lg:h-32 rounded-full border-4 border-white shadow-lg object-cover"
                  />
                  <!-- Verified Badge -->
                  <div class="absolute -bottom-2 -right-2 bg-green-500 rounded-full p-2 border-4 border-white">
                    <mat-icon class="text-white w-4 h-4" style="font-size: 1rem; height: 1rem; width: 1rem;">verified</mat-icon>
                  </div>
                </div>
                
                <div class="text-white flex-1">
                  <h1 class="text-3xl lg:text-4xl font-bold mb-2">{{vm.data?.name}}</h1>
                  <p class="text-lg text-gray-200 mb-3 max-w-2xl">{{vm.data?.description}}</p>
                  
                  <div class="flex flex-wrap items-center gap-4 text-sm">
                    <div class="flex items-center bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full">
                      <mat-icon class="text-yellow-400 mr-1 w-4 h-4" style="font-size: 1rem; height: 1rem; width: 1rem;">star</mat-icon>
                      <span class="font-medium">{{vm.data?.rating}}</span>
                    </div>
                    
                    <div class="flex items-center bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full">
                      <mat-icon class="text-blue-300 mr-1 w-4 h-4" style="font-size: 1rem; height: 1rem; width: 1rem;">inventory_2</mat-icon>
                      <span>{{(vm.data?.productCount || 0) | number}} Produits</span>
                    </div>
                    
                    <div class="flex items-center bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full">
                      <mat-icon class="text-green-300 mr-1 w-4 h-4" style="font-size: 1rem; height: 1rem; width: 1rem;">schedule</mat-icon>
                      <span>Membre depuis {{vm.data?.createdAt ? (vm.data?.createdAt | date:'MMM yyyy') : 'N/A'}}</span>
                    </div>
                    
                    <div class="flex items-center bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full">
                      <div 
                        class="w-2 h-2 rounded-full mr-2"
                        [class.bg-green-400]="vm.data?.status === 'active'"
                        [class.bg-red-400]="vm.data?.status !== 'active'"
                      ></div>
                      <span class="capitalize">{{vm.data?.status}}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Market Statistics Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 stat-card">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                <mat-icon class="text-blue-600">inventory_2</mat-icon>
              </div>
              <div>
                <p class="text-sm text-gray-500">Produits</p>
                <p class="text-2xl font-bold text-gray-900">{{vm.data?.productCount || 0 | number}}</p>
              </div>
            </div>
          </div>
          
          <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 stat-card">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4 stat-icon">
                <mat-icon class="text-yellow-600">star</mat-icon>
              </div>
              <div>
                <p class="text-sm text-gray-500">Note</p>
                <p class="text-2xl font-bold text-gray-900">{{vm.data?.rating}}/5</p>
              </div>
            </div>
          </div>
          
          <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 stat-card">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4 stat-icon">
                <mat-icon class="text-green-600">local_shipping</mat-icon>
              </div>
              <div>
                <p class="text-sm text-gray-500">Livraison</p>
                <p class="text-lg font-bold text-gray-900">Rapide</p>
              </div>
            </div>
          </div>
          
          <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 stat-card">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4 stat-icon">
                <mat-icon class="text-purple-600">schedule</mat-icon>
              </div>
              <div>
                <p class="text-sm text-gray-500">Statut</p>
                <p class="text-lg font-bold text-green-600 capitalize">{{vm.data?.status}}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Products Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Produits de la Boutique</h2>
            <div class="flex items-center space-x-2 text-sm text-gray-500">
              <mat-icon class="w-4 h-4" style="font-size: 1rem; height: 1rem; width: 1rem;">filter_list</mat-icon>
              <span>Filtres disponibles prochainement</span>
            </div>
          </div>
          
          @if (products$ | async; as productsVm) {
            @switch (productsVm.status) {
              @case ('loading') {
                <div class="flex justify-center items-center p-12">
                  <div class="text-center">
                    <mat-spinner diameter="40" class="mb-4"></mat-spinner>
                    <p class="text-gray-500">Chargement des produits...</p>
                  </div>
                </div>
              }
              @case ('error') {
                <div class="text-center p-12">
                  <mat-icon class="text-6xl text-red-500 mb-4">error_outline</mat-icon>
                  <h3 class="text-xl font-semibold text-gray-900 mb-2">Erreur de Chargement</h3>
                  <p class="text-gray-600 mb-6">{{productsVm.error}}</p>
                  <button 
                    type="button"
                    mat-raised-button 
                    color="primary" 
                    (click)="loadMarketProducts(vm.data?.id!)"
                  >
                    Réessayer
                  </button>
                </div>
              }
              @case ('success') {
                @if (productsVm.data?.length) {
                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    @for (product of productsVm.data; track product.id) {
                      <app-marketplace-product-card
                        [product]="product"
                        (addToCart)="addToCart($event)"
                        class="transform transition-all duration-200 hover:-translate-y-1"
                      />
                    }
                  </div>
                } @else {
                  <div class="text-center p-12">
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <mat-icon class="text-4xl text-gray-400">inventory_2</mat-icon>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Aucun Produit Disponible</h3>
                    <p class="text-gray-600 mb-6">Cette boutique n'a pas encore ajouté de produits.</p>
                    <button 
                      type="button"
                      mat-button 
                      routerLink="/marketplace" 
                      class="text-blue-600 hover:text-blue-700"
                    >
                      Explorer d'Autres Boutiques
                    </button>
                  </div>
                }
              }
            }
          }
        </div>
      }
    }
  }
</div>