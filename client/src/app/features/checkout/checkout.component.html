<div class="checkout-container">
  @if (cart$ | async; as cart) {
    <!-- Header Section -->
    <div class="checkout-header">
      <button 
        type="button"
        mat-button
        routerLink="/cart" 
        class="back-button"
      >
        <mat-icon>arrow_back</mat-icon>
        Retour au Panier
      </button>

      <h1>Finaliser la Commande</h1>
      <p class="subtitle">Complétez vos informations pour procéder au paiement</p>
    </div>

    <div class="checkout-grid">
      <!-- Left Column - Forms -->
      <div class="checkout-forms">
        <form [formGroup]="checkoutForm" (ngSubmit)="placeOrder()">
          <!-- Shipping Information -->
          <div class="form-section">
            <div class="form-section-header">
              <h3>
                <mat-icon>location_on</mat-icon>
                Informations de Livraison
              </h3>
            </div>
            <div class="form-section-content">
              
              <!-- Address Selection Mode Choice -->
              <div class="address-mode-selection" *ngIf="savedAddresses.length > 0">
                <mat-radio-group [(ngModel)]="selectedAddressMode" (change)="onAddressModeChange()">
                  <mat-radio-button value="existing" class="address-option">
                    Utiliser une adresse existante
                  </mat-radio-button>
                  <mat-radio-button value="new" class="address-option">
                    Ajouter une nouvelle adresse
                  </mat-radio-button>
                </mat-radio-group>
              </div>

              <!-- Existing Address Selection -->
              <div *ngIf="savedAddresses.length > 0 && selectedAddressMode === 'existing'" class="existing-addresses">
                <mat-radio-group [(ngModel)]="selectedAddressId" (change)="onAddressSelect($event)">
                  <div *ngFor="let address of savedAddresses" class="address-card">
                    <mat-radio-button [value]="address.id">
                      <div class="address-details">
                        <div class="address-name">{{ address.addressLine1 }}</div>
                        <div class="address-full">
                          {{ address.addressLine2 }}, {{ address.city }}
                          <span *ngIf="address.postalCode">, {{ address.postalCode }}</span>
                        </div>
                        <div class="address-phone">{{ address.phone }}</div>
                        <span *ngIf="address.isDefault" class="default-badge">Par défaut</span>
                      </div>
                    </mat-radio-button>
                  </div>
                </mat-radio-group>
              </div>

              <!-- New Address Form -->
              <div *ngIf="selectedAddressMode === 'new' || savedAddresses.length === 0" 
                   formGroupName="shippingAddress">
                <div class="address-form">
                <mat-form-field appearance="fill">
                  <mat-label>Nom Complet *</mat-label>
                  <input matInput formControlName="addressLine1" required>
                  <mat-error>Ce champ est requis</mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Téléphone *</mat-label>
                  <input matInput formControlName="phone" type="tel" required>
                  <mat-error>Ce champ est requis</mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Adresse Complète *</mat-label>
                  <input matInput formControlName="addressLine2" required>
                  <mat-error>Ce champ est requis</mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Ville *</mat-label>
                  <input matInput formControlName="city" required>
                  <mat-error>Ce champ est requis</mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Région</mat-label>
                  <input matInput formControlName="state">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Pays *</mat-label>
                  <input matInput formControlName="country" value="Sénégal" required>
                  <mat-error>Ce champ est requis</mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Code Postal</mat-label>
                  <input matInput formControlName="postalCode">
                </mat-form-field>

                <!-- Make Default Address Checkbox -->
                <div class="default-address-option" *ngIf="selectedAddressMode === 'new' || savedAddresses.length === 0">
                  <mat-checkbox [(ngModel)]="makeDefaultAddress">
                    Définir comme adresse par défaut
                  </mat-checkbox>
                </div>
              </div>
              </div>
            </div>
          </div>

          <!-- Delivery Zone - Only for new addresses -->
          <div class="form-section" *ngIf="selectedAddressMode === 'new' || savedAddresses.length === 0">
            <div class="form-section-header">
              <h3>
                <mat-icon>local_shipping</mat-icon>
                Zone de Livraison
              </h3>
            </div>
            <div class="form-section-content" formGroupName="shippingAddress">
              <mat-form-field appearance="fill" class="w-full">
                <mat-label>Sélectionner une zone de livraison *</mat-label>
                <mat-select formControlName="zone" required>
                  @for (zone of zones; track zone.id) {
                    <mat-option [value]="zone">
                      {{ zone.name }} - {{ zone.fee.toLocaleString() }} FCFA
                      <span class="text-xs text-gray-500 block">
                        Délai: 24-48h
                      </span>
                    </mat-option>
                  }
                </mat-select>
                <mat-error>Veuillez sélectionner une zone de livraison</mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- Zone Information for existing addresses -->
          <div class="form-section" *ngIf="selectedAddressMode === 'existing' && savedAddresses.length > 0 && checkoutForm.get('shippingAddress.zone')?.value">
            <div class="form-section-header">
              <h3>
                <mat-icon>local_shipping</mat-icon>
                Zone de Livraison
              </h3>
            </div>
            <div class="form-section-content">
              <div class="zone-display">
                <div class="zone-info">
                  <strong>{{ checkoutForm.get('shippingAddress.zone')?.value.name }}</strong>
                  <span class="zone-fee">{{ checkoutForm.get('shippingAddress.zone')?.value.fee.toLocaleString() }} FCFA</span>
                  <span class="zone-delivery">Délai: 24-48h</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="form-section">
            <div class="form-section-header">
              <h3>
                <mat-icon>payment</mat-icon>
                Mode de Paiement
              </h3>
            </div>
            <div class="form-section-content">
              <div class="payment-options">
                <div class="payment-option">
                  <input 
                    type="radio" 
                    id="mobile-money" 
                    name="payment" 
                    value="mobile"
                    formControlName="paymentMethod"
                  >
                  <div class="option-content">
                    <div class="option-title">Mobile Money</div>
                    <div class="option-description">Orange Money, Wave, Free Money</div>
                  </div>
                </div>

                <div class="payment-option">
                  <input 
                    type="radio" 
                    id="cash-delivery" 
                    name="payment" 
                    value="cash"
                    formControlName="paymentMethod"
                  >
                  <div class="option-content">
                    <div class="option-title">Paiement à la Livraison</div>
                    <div class="option-description">Payez en espèces lors de la réception</div>
                  </div>
                </div>

                <div class="payment-option">
                  <input 
                    type="radio" 
                    id="card" 
                    name="payment" 
                    value="card"
                    formControlName="paymentMethod"
                  >
                  <div class="option-content">
                    <div class="option-title">Carte Bancaire</div>
                    <div class="option-description">Visa, Mastercard</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Right Column - Order Summary -->
      <div class="order-summary">
        <div class="summary-card">
          <div class="summary-card-header">
            <h3>Résumé de la Commande</h3>
          </div>
          
          <div class="summary-card-content">
            <!-- Order Items -->
            <div class="order-items">
              @if (cart && cart.items && cart.items.length > 0) {
                @for (item of cart.items; track item.id) {
                  <div class="order-item">
                    <div class="item-info">
                      <div class="item-name">{{ item.product.name }}</div>
                      <div class="item-quantity">Qté: {{ item.quantity }}</div>
                    </div>
                    <div class="item-price">
                      {{ (item.product.price * item.quantity) | currency:'XOF':'symbol':'1.0-0' }}
                    </div>
                  </div>
                }
              } @else {
                <div class="no-items">
                  <p>Aucun article dans le panier</p>
                </div>
              }
            </div>
            
            <!-- Pricing Breakdown -->
            <div class="pricing-breakdown" *ngIf="cart">
              <div class="pricing-row">
                <span class="label">Sous-total</span>
                <span class="value">{{ getSubtotal(cart) | currency:'XOF':'symbol':'1.0-0' }}</span>
              </div>
              
              <div class="pricing-row">
                <span class="label">Livraison</span>
                <span class="value">
                  {{ getDeliveryFee() | currency:'XOF':'symbol':'1.0-0' }}
                </span>
              </div>
              
              @if (checkoutForm.get('shippingAddress.zone')?.value) {
                <div class="pricing-row zone-info">
                  <span class="label">Zone: {{ checkoutForm.get('shippingAddress.zone')?.value.name }}</span>
                  <span class="value">Délai: 24-48h</span>
                </div>
              }
              
              <div class="pricing-row total">
                <span class="label">Total</span>
                <span class="value">{{ getTotal(cart) | currency:'XOF':'symbol':'1.0-0' }}</span>
              </div>
            </div>
            
            <!-- Checkout Button -->
            <button 
              type="button"
              class="checkout-button"
              (click)="placeOrder()"
              [disabled]="checkoutForm.invalid || isProcessing"
            >
              @if (isProcessing) {
                <mat-spinner diameter="20"></mat-spinner>
                Traitement...
              } @else {
                <mat-icon>shopping_cart_checkout</mat-icon>
                Confirmer la Commande
              }
            </button>
            
            <p class="terms-notice">
              En confirmant votre commande, vous acceptez nos conditions de vente.
            </p>
          </div>
        </div>
      </div>
    </div>
  } @else {
    <!-- Empty Cart State -->
    <div class="empty-cart">
      <div class="empty-icon">
        <mat-icon>shopping_cart</mat-icon>
      </div>
      
      <h2>Panier Vide</h2>
      <p class="description">
        Votre panier est vide. Ajoutez des produits pour continuer.
      </p>
      
      <button 
        type="button"
        routerLink="/marketplace" 
        class="action-button"
      >
        <mat-icon>store</mat-icon>
        Continuer les Achats
      </button>
    </div>
  }
</div>